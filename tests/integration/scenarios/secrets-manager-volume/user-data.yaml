disable-services:
  - chrony
  - ssh
volumes:
  - secrets-manager:
      secret-id: app/database-password
      mount:
        destination: /secrets/db-password
command:
  - /bin/sh
  - -c
  - |
    exec >/dev/ttyS0 2>&1
    echo "=== secrets-manager test ==="

    # Check if secret was mounted
    if [ ! -f /secrets/db-password ]; then
        echo "FAIL: /secrets/db-password not found"
        exit 1
    fi

    # Verify content
    content=$(cat /secrets/db-password)
    if [ "$content" != "super-secret-password-123" ]; then
        echo "FAIL: db-password has wrong content: $content"
        exit 1
    fi

    # Verify file permissions (should be 600 for secrets)
    perms=$(stat -c %a /secrets/db-password)
    if [ "$perms" != "600" ]; then
        echo "FAIL: db-password has wrong permissions: $perms (expected 600)"
        exit 1
    fi

    echo "Secrets Manager secret verified"
    echo "PASS"
