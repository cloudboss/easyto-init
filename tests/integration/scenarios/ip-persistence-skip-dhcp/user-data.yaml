disable-services:
  - chrony
  - ssh
command:
  - /bin/sh
  - -c
  - |
    exec >/dev/ttyS0 2>&1
    echo "=== ip-persistence-skip-dhcp test ==="

    # Check the IP address is configured (should be from persisted config)
    ip_addr=$(ip -4 addr show eth0 | grep -o 'inet [0-9.]*' | awk '{print $2}')
    if [ "${ip_addr}" != "10.0.2.15" ]; then
        echo "FAIL: Expected IP 10.0.2.15, got ${ip_addr}"
        exit 1
    fi
    echo "IP address: ${ip_addr} (correct)"

    # Test connectivity to the host (IMDS mock server)
    if ! curl -s -o /dev/null "http://10.0.2.2:8080/latest/meta-data/instance-id"; then
        echo "FAIL: Cannot reach mock IMDS server"
        exit 1
    fi
    echo "Network connectivity verified"

    # Check that resolv.conf was written from persisted DNS config
    if ! grep -q "nameserver 8.8.8.8" /etc/resolv.conf; then
        echo "FAIL: /etc/resolv.conf missing nameserver 8.8.8.8"
        cat /etc/resolv.conf
        exit 1
    fi
    if ! grep -q "domain example.com" /etc/resolv.conf; then
        echo "FAIL: /etc/resolv.conf missing domain example.com"
        cat /etc/resolv.conf
        exit 1
    fi
    if ! grep -q "search example.com test.local" /etc/resolv.conf; then
        echo "FAIL: /etc/resolv.conf missing search domains"
        cat /etc/resolv.conf
        exit 1
    fi
    echo "DNS configuration restored from persisted state"

    echo ""
    echo "PASS"
